// firestore.rules (temporary while you build)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }
    function hasClaim(claim) {
      return isSignedIn() && request.auth.token[claim] == true;
    }
    function isAdmin() {
      return hasClaim("admin");
    }
    function isStaff() {
      return (
        isAdmin() ||
        hasClaim("staff") ||
        hasClaim("theatre_staff") ||
        hasClaim("actor_support_staff") ||
        hasClaim("pas_staff") ||
        hasClaim("pas_support")
      );
    }
    function isSuperUser() {
      return isSignedIn() && request.auth.token.email == "ensemble@blueteapot.ie";
    }
    function isActor() {
      return hasClaim("actor");
    }
    function isStudent() {
      return hasClaim("student");
    }

    function userProfile() {
      return isSignedIn()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : null;
    }

    function targetUserRole() {
      // prefer incoming data (create/update), else fall back to stored doc
      return request.resource != null && request.resource.data != null && request.resource.data.role != null
        ? request.resource.data.role
        : (resource != null && resource.data != null && resource.data.role != null ? resource.data.role : null);
    }

    function hasUserRoleRead(targetRole) {
      let profile = userProfile();
      return isSuperUser() ||
        (profile != null &&
          profile.permissions != null &&
          (
            (profile.permissions.users != null && profile.permissions.users.read == true) ||
            (targetRole == "actor" && profile.permissions.userActors != null && profile.permissions.userActors.read == true) ||
            (targetRole == "student" && profile.permissions.userStudents != null && profile.permissions.userStudents.read == true)
          ));
    }

    function hasUserRoleWrite(targetRole) {
      let profile = userProfile();
      return isSuperUser() ||
        (profile != null &&
          profile.permissions != null &&
          (
            (profile.permissions.users != null && profile.permissions.users.write == true) ||
            (targetRole == "actor" && profile.permissions.userActors != null && profile.permissions.userActors.write == true) ||
            (targetRole == "student" && profile.permissions.userStudents != null && profile.permissions.userStudents.write == true)
          ));
    }

    function hasStrandWrite(strand) {
      let profile = userProfile();
      return profile != null &&
        profile.permissions != null &&
        profile.permissions[strand] != null &&
        profile.permissions[strand].write == true;
    }

    function canWriteTasks() {
      return isAdmin() || isStaff() || hasStrandWrite("actors") || hasStrandWrite("students");
    }

    function canReadTasks() {
      // Allow readers (actors/students) plus anyone who can write
      return isActor() || isStudent() || canWriteTasks();
    }

    // User directory
    match /users/{uid} {
      // Read: super-user, delegated read for the target role, theatre staff, or self
      allow read: if hasUserRoleRead(targetUserRole()) || isStaff() || (isSignedIn() && request.auth.uid == uid);
      // Write: super-user or delegated write for the target role
      allow write: if hasUserRoleWrite(targetUserRole());
    }

    match /groups/{groupId} {
      allow read: if isStaff();
      allow write: if isStaff();
    }

    match /tasks/{taskId} {
      allow read: if canReadTasks();
      allow write: if canWriteTasks();
    }

    // Task title templates / suggestions
    match /taskList/{docId} {
      allow read: if canReadTasks();
      allow write: if canWriteTasks();
    }

    // Everything else stays admin-only until explicitly opened
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
